# Plan: Add Hosted Sweep Authentication Support

## Overview
Extend cursortab.nvim to support the hosted version of Sweep (https://autocomplete.sweep.dev) with API key authentication. The hosted Sweep uses a simple API key flow (no OAuth) where the key is passed as a Bearer token.

## Current State Analysis

### Existing Sweep Provider (Local)
- **File**: `server/provider/sweep/sweep.go`
- Uses OpenAI-compatible client (`client/openai/openai.go`)
- No authentication currently implemented
- Connects to local URL (e.g., `http://localhost:8000`)

### Authentication Requirements (from Zed's implementation)
- **Key Source**: Environment variable `SWEEP_AI_TOKEN` OR keychain entry
- **API URL**: `https://autocomplete.sweep.dev`
- **Auth Header**: `Authorization: Bearer <token>`
- **Endpoints**:
  - Autocomplete: `/v1/autocomplete`
  - Metrics: `/v1/metrics` (fire-and-forget)

### Response Format (Sweep Hosted)
```json
{
  "autocomplete_id": "string",
  "start_index": 0,
  "end_index": 0,
  "completion": "string",
  "confidence": 0.0,
  "logprobs": {},
  "finish_reason": "string",
  "elapsed_time_ms": 0,
  "completions": [
    {
      "start_index": 0,
      "end_index": 0,
      "completion": "string",
      "confidence": 0.0,
      "autocomplete_id": "string",
      "logprobs": {},
      "finish_reason": "string"
    }
  ]
}
```

## Implementation Plan

### Phase 1: Configuration Updates

#### 1.1 Update Lua Configuration (`lua/cursortab/config.lua`)
Add new configuration options for hosted Sweep:

```lua
provider = {
  type = "sweep",  -- or "sweep-hosted"
  url = "https://autocomplete.sweep.dev",  -- New default for hosted
  api_key = nil,  -- Optional: explicit API key (not recommended)
  api_key_env = "SWEEP_AI_TOKEN",  -- Environment variable name
  -- ... existing options
}
```

**Changes needed**:
- Add `api_key` field to `CursortabProviderConfig` type
- Add `api_key_env` field for customizable env var name
- Update default config with hosted Sweep URL
- Add validation for new fields

#### 1.2 Update Go Config (`server/main.go`)
Add corresponding fields to Go Config struct:

```go
type ProviderConfig struct {
  // ... existing fields
  APIKey    string `json:"api_key"`
  APIKeyEnv string `json:"api_key_env"`
}
```

### Phase 2: Create Sweep-Specific HTTP Client

#### 2.1 Create New Client Package (`server/client/sweep/sweep.go`)
Create a dedicated Sweep client that:
- Reads API key from env var (fallback to config)
- Adds `Authorization: Bearer <token>` header to all requests
- Handles the Sweep-specific response format
- Sends metrics requests asynchronously (fire-and-forget)

**Key implementation details**:
```go
type Client struct {
  HTTPClient *http.Client
  BaseURL    string
  APIKey     string
}

func (c *Client) DoAutocomplete(ctx context.Context, req *AutocompleteRequest) (*AutocompleteResponse, error) {
  // Add Bearer token header
  // POST to /v1/autocomplete
  // Parse Sweep-specific response format
}

func (c *Client) SendMetrics(ctx context.Context, metrics *MetricsRequest) {
  // Fire-and-forget metrics call
  // POST to /v1/metrics
}
```

#### 2.2 API Key Resolution Logic
Implement key resolution in priority order:
1. Explicit `api_key` from config (if provided)
2. Environment variable `SWEEP_AI_TOKEN` (or custom env var)
3. Return error if no key found

### Phase 3: Update Sweep Provider

#### 3.1 Modify `server/provider/sweep/sweep.go`
- Add support for detecting hosted vs local mode
- Use Sweep-specific client for hosted mode
- Keep OpenAI-compatible client for local mode

**Detection logic**:
```go
func NewProvider(config *types.ProviderConfig) *provider.Provider {
  if isHostedURL(config.ProviderURL) {
    // Use Sweep client with auth
    client := sweep.NewClient(config.ProviderURL, getAPIKey(config))
    return &provider.Provider{
      Client: client,
      // ...
    }
  }
  // Use existing OpenAI client for local
  return &provider.Provider{
    Client: openai.NewClient(config.ProviderURL, config.CompletionPath),
    // ...
  }
}
```

### Phase 4: Request/Response Format Adaptation

#### 4.1 Sweep Request Format
The hosted Sweep API likely expects a different request format than local. Based on Zed's implementation, the request should include:
- File path
- Current file content
- Cursor position
- Diff history (if available)

#### 4.2 Response Parsing
Update response parsing to handle Sweep's format:
- Extract completion from `completion` field (not `choices[0].text`)
- Handle `completions` array for additional suggestions
- Parse `start_index`/`end_index` for byte offsets

### Phase 5: Lua-side API Key Management

#### 5.1 Add Commands for Key Management
New user commands:
- `:CursortabSweepSetKey <key>` - Set API key interactively
- `:CursortabSweepClearKey` - Clear stored key
- `:CursortabSweepStatus` - Show key status (env var vs explicit)

#### 5.2 Secure Key Storage (Optional)
Consider using Neovim's `vim.fn.system()` to interact with system keychain:
- macOS: `security` command
- Linux: `secret-tool` or `pass`
- Windows: `cmdkey` or PowerShell

**Note**: For initial implementation, env var is sufficient. Keychain integration can be added later.

### Phase 6: Documentation and Examples

#### 6.1 Update README.md
Add section for hosted Sweep:
```lua
-- Hosted Sweep configuration
require("cursortab").setup({
  provider = {
    type = "sweep",
    url = "https://autocomplete.sweep.dev",
    -- API key from SWEEP_AI_TOKEN env var (default)
  },
})
```

#### 6.2 Add Help Documentation
Update vimdoc with:
- New configuration options
- Environment variable setup
- Troubleshooting auth issues

## File Changes Summary

### Modified Files:
1. `lua/cursortab/config.lua` - Add auth config options
2. `lua/cursortab/daemon.lua` - Pass auth config to Go daemon
3. `server/main.go` - Add auth fields to Config struct
4. `server/provider/sweep/sweep.go` - Support hosted mode with auth
5. `README.md` - Document hosted Sweep setup

### New Files:
1. `server/client/sweep/sweep.go` - Sweep-specific HTTP client
2. `server/client/sweep/types.go` - Sweep request/response types

## Testing Strategy

### Unit Tests:
- API key resolution logic
- Request header construction
- Response parsing for Sweep format

### Integration Tests:
- Mock Sweep server that validates Bearer token
- End-to-end test with env var auth

### Manual Testing:
1. Set `SWEEP_AI_TOKEN` env var
2. Configure provider with hosted URL
3. Verify completions work
4. Check logs for proper auth header

## Security Considerations

1. **API Key Storage**: Never log the API key
2. **Env Var**: Warn if key is in env var (visible to all processes)
3. **Config File**: If key is in Lua config, warn about security implications
4. **HTTPS Only**: Enforce HTTPS for hosted Sweep URL

## Migration Path

Existing users with local Sweep should see no changes. The hosted mode is opt-in via URL configuration.

## Open Questions

1. Should we support both local and hosted Sweep simultaneously (e.g., fallback)?
2. Do we need to cache the API key in memory or read from env var on each request?
3. What metrics should be sent to Sweep's metrics endpoint?
4. Should we implement keychain integration in the first version?

## Timeline Estimate

- Phase 1 (Config): 30 minutes
- Phase 2 (Client): 1-2 hours
- Phase 3 (Provider): 30 minutes
- Phase 4 (Request/Response): 1 hour
- Phase 5 (Lua commands): 30 minutes
- Phase 6 (Docs): 30 minutes

**Total: 4-5 hours**
